#!/usr/bin/env php
<?php

$loader = null;

foreach ([__DIR__ . '/../../../autoload.php', __DIR__ . '/../vendor/autoload.php'] as $file) {
	if (true === file_exists($file)) {
        require_once $loader = $file;
		break;
	}
}

if (null === $loader) {
    echo 'You must set up the project dependencies using `composer install`'.PHP_EOL.
        'See https://getcomposer.org/download/ for instructions on installing Composer'.PHP_EOL;
    exit(1);
}

// Remove bin/phx entry from arguments
array_shift($argv);
--$argc;

if ($argc === 0) {
	$handle = fopen('php://stdin', 'r');

	for (;;) {
		$line = fgets($handle);
	}

	fclose($handle);
} else {
	$scriptPath = realpath($argv[0]);

	$extensions = [

    ];

	if(false === file_exists($scriptPath)) {
		die(sprintf('Could not open input file: %s' . PHP_EOL, $argv[0]));
	}

	$transpiler = \Phx\Common\TranspilerBuilder::create()
        ->setParser(new \Phx\Parser\Phx(new \Phx\Lexer\PhxLexer()))
        ->setPrinter(new \PhpParser\PrettyPrinter\Standard())
        ->registerExtension(new \Phx\Extension\Spread\SpreadExtension())
        ->registerExtension(new \Phx\Extension\ForIn\ForInExtension())
        ->build();

    $code = $transpiler->fromFile($scriptPath);

	file_put_contents(getcwd().'/dump.php', '<?php'.PHP_EOL.$code);
	eval($code);
}