#!/usr/bin/env php
<?php

$loader = null;

foreach ([__DIR__ . '/../../../autoload.php', __DIR__ . '/../vendor/autoload.php'] as $file) {
	if (true === file_exists($file)) {
        require_once $loader = $file;
		break;
	}
}

if (null === $loader) {
    echo 'You must set up the project dependencies using `composer install`'.PHP_EOL.
        'See https://getcomposer.org/download/ for instructions on installing Composer'.PHP_EOL;
    exit(1);
}

// Remove bin/phx entry from arguments
array_shift($argv);
--$argc;

if ($argc === 0) {
	$handle = fopen('php://stdin', 'r');

	for (;;) {
		$line = fgets($handle);
	}

	fclose($handle);
} else {
	$scriptPath = realpath($argv[0]);

	if(false === file_exists($scriptPath)) {
		die(sprintf('Could not open input file: %s' . PHP_EOL, $argv[0]));
	}

	$lexer = new \Phx\Lexer\PhxLexer();
	$parser = new \Phx\Parser\Phx($lexer, []);
	$nodeDumper = new \PhpParser\NodeDumper;
	$prettyPrinter = new \PhpParser\PrettyPrinter\Standard();

	$nodeConnector =  new \Phx\Common\NodeConnector();
	$arraySpreader = new \Phx\Common\ArraySpreader();

	$traverser = new \PhpParser\NodeTraverser();
	$traverser->addVisitor($nodeConnector);
	$traverser->addVisitor($arraySpreader);

	$stmts = $parser->parse(file_get_contents($scriptPath));
    echo $nodeDumper->dump($stmts); exit;

    $stmts = $traverser->traverse($stmts);

echo $nodeDumper->dump($stmts); exit;
	$code = $prettyPrinter->prettyPrint($stmts);
	file_put_contents(getcwd().'/dump.php', '<?php'.PHP_EOL.$code);
	eval($code);
}